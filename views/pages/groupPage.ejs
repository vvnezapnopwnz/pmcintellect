<!DOCTYPE html>
<html>
<head>
  <%- include ("../partials/header.ejs") %>
  <script src="https://cdn.jsdelivr.net/gh/linways/table-to-excel@v1.0.4/dist/tableToExcel.js"></script>

</head>

<body>

  <%- include ("../partials/nav.ejs") %>

<div class="container">
    <div class="row my-3 group__block">
      <div class="col">
        <div class="group__info d-flex flex-column justify-content-start">
          <h4 class="btn btn-success">
             Группа: <%= group.name %>
          </h4>
          <h4 class="btn btn-success">
              Класс:
              <%= group.class_number %>
          </h4>
      </div>
      </div>
    </div>
    <div class="row d-flex group__block my-3">
        <div class="group__info">
          <h4 class="students_content_title text-center">
            Состав группы по предметам
          </h4>
            <div class="d-flex flex-row my-3 justify-content-around">
              <% group_students_by_subjects.forEach(function(subject) { %>

                <div class="d-flex flex-column students__content mx-1">
                  <b><%= subject.name %> :</b>
                <% subject.subject_students.forEach(function(student) { %>
                  <a href=<%= `${globalLink}/students/${student.student_id}/` %> class="btn btn-warning my-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-person" viewBox="0 0 16 16">
                      <path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z"/>
                    </svg>
                    <strong><%= student.student_name %></strong>
                  </a>
                <% }); %>
                </div>
              <% }); %>
            </div>


        </div>
      </div>


<div class="row d-flex group__block my-2">
  <div class="col-md-6 col-12">
    <div class="students__content">
      <a href=<%= `${globalLink}/groups/${group.group_id}/addStudent` %> class="btn btn-primary my-2">
      Добавить ученика в эту группу
      </a>
      <a href=<%= `${globalLink}/groups/${group.group_id}/removeStudent` %> class="btn btn-danger my-2">
        Удалить ученика из группы
        </a>
    </div>
  </div>
  
  <div class="col-md-6 col-12">
    <div class="subjects__content">
      <a href=<%= `${globalLink}/groups/${group.group_id}/addSubject` %> class="btn btn-primary my-2">
      Добавить предмет в эту группу
      </a>
      <a href=<%= `${globalLink}/groups/${group.group_id}/removeSubject` %> class="btn btn-danger my-2">
        Удалить предмет из группы
        </a>
    </div>
  </div>
</div>





    <div class="row d-flex group__block my-4">
      <div class="col py-2">
        <h4 class="text-center">Тесты</h4>
        <div class="tests__content">
          <a href=<%= `${globalLink}/groups/${group.group_id}/addComplexTest` %> class="btn btn-primary my-2">
          Добавить тест в эту группу
          </a>
          <a href=<%= `${globalLink}/groups/${group.group_id}/removeComplexTest` %> class="btn btn-danger my-2">
            Удалить тест из группы
            </a>
        </div>
      </div>
    </div>



    <div class="row d-flex flex-column group__block my-4 justify-content-center align-items-center">
      <div class="row d-flex flex-column">
        <div class="col py-2">
          <h4 class="text-center">Характеристики</h4>
          <h5 class="text-center">Добавить характеристики в группу</h5>
          <div class="review__content">
            <% subjects.forEach(function(subject) { %>
            <a href=<%= `${globalLink}/groups/${group.group_id}/${subject.subject_id}/addReview` %> class="btn btn-secondary my-2">
              <%= subject.name %>
            </a>
            <% }); %>
            <a href=<%= `${globalLink}/groups/${group.group_id}/removeReview` %> class="btn btn-danger my-2">
              Удалить характеристики из группы
              </a>
          </div>
        </div>
      </div>
      <div class="row d-flex">
        <div class="accordion" id="accordion">
          <div class="accordion-item">
            <h2 class="accordion-header" id="headingSubject">
              <button class="accordion-button d-block text-center bg-primary" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSubject">
                <h5 class="text-light">Найти характеристики</h5>
              </button>
            </h2>
            <div id="collapseSubject" class="accordion-collapse collapse" aria-labelledby="headingSubject" data-bs-parent="#accordion">
              <div class="accordion-body d-flex flex-column bg-warning">
                <div class="input_field">
                  <input type="month" class="month_form form-control input-sm" placeholder=""w50" >
                </div>
                <div class="table-responsive-lg">
                  <table class="table table-striped table-hover table-bordered border-primary">
                    <tbody class="async__find">
                      <tr>
                        <th>Дата проведения</th>
                        <th>Предмет</th>
                        <th>Посещаемость</th>
                        <th>Активность</th>
                        <th>Выполнение ДЗ</th>
                        <th>Подробнее</th>
                     </tr>
                    </tbody>
                  </table>
                </div>

              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
  const inputCharsValue = document.querySelector('.month_form');
  const tableBlock = document.querySelector('.async__find');

inputCharsValue.addEventListener('change', async (event) => {


  tableBlock.innerHTML = `<tr><th>Дата проведения</th><th>Предмет</th><th>Посещаемость</th><th>Активность</th><th>Выполнение ДЗ</th><th>Подробнее</th></tr>`

  const queryToDB = await fetch(`<%= globalLink %>/reviews/async/${event.target.value}/<%= group.group_id %>`)

  const response = await queryToDB.json()


  response.forEach((item) => {

    const trEl = document.createElement('tr')
    tableBlock.appendChild(trEl);
    const dateCol = document.createElement('td')
    dateCol.innerText = new Date(item.posting_date).toLocaleDateString('ru-RU');
    const subjectCol = document.createElement('td')
    subjectCol.innerText = item.subject_name;
    const attendanceCountCol = document.createElement('td')
    attendanceCountCol.innerText = item.attendance_count;
    const activityCountCol = document.createElement('td')
    activityCountCol.innerText = item.activity_count;
    const homeworkCountCol = document.createElement('td');
    homeworkCountCol.innerText = item.homework_count;
    const linkCol = document.createElement('td');
    linkCol.innerHTML = `<a href="<%= globalLink %>/reviews/${item.review_id}"><button class="btn btn-primary">Подробнее</button></a>`;

    trEl.appendChild(dateCol);
    trEl.appendChild(subjectCol);
    trEl.appendChild(attendanceCountCol);
    trEl.appendChild(activityCountCol);
    trEl.appendChild(homeworkCountCol);
    trEl.appendChild(linkCol);

  })

});

    </script>





    <% formats.forEach(function(format) { %>

      
      <div class="row d-flex group__block my-3">
        <div class="group__info">
          <h4 class="students_content_title text-center">
            Тесты по формату: <%= format.format ? format.format : 'Не указан' %>
          </h4>

          <% format.subjects.forEach((subject) => { %>
          <%  if(subject.tests.length > 0) { %>
          <div class="row d-flex flex-column">
            <p class="text-end">
              <%= subject.name %>
            </p>

            <div class="table-responsive-lg">
              <table class="table table-striped table-hover table-bordered border-primary">
                <tbody class="tbody__reverse">
                <tr>
                  <th></th>
                   <th class="students">Ученики</th>
                  <% unique_students.sort().forEach(function(student) { %>
                   <th class="student_name">
                    <%= student %>
                   </th>
                   <% }); %>
                </tr>
                <% subject.tests.forEach(function(test) { %>
                <tr>
                  <td>
                    <%= test.test_date.toLocaleDateString('ru-RU') %>
                  </td>
                  <th>
                    Баллы
                  </th>
                  <% test.students.forEach(function(student) { %>
                    <th>
                      <% if(student.results.length > 0) { %>
                      <%= student.results[0].points %> / <%= student.results[0].max_points %> 
                        <% } else { %>
                          -
                        <% } %>
                    </th>
                    <% }); %>
                </tr>
                <tr>
                  <td>
                    <%= test.theme %>
                  </td>
                  <td class="fw-bold">
                    Процент от макс.
                  </td>
                  <% test.students.forEach(function(student) { %>
                    <th>
                      <% if(student.results.length > 0) { %>
                      <%= Math.round((student.results[0].points / student.results[0].max_points) * 100) %> %
                      <% } else { %>
                        -
                      <% } %>
                    </th>
                    <% }); %>
                </tr>
                <% }); %>
                </tbody>
              </table>
            </div>
            <button class="btn btn-success w-25 m-1" id="btnExport" onclick="exportReportToExcel(this)">Скачать таблицу</button>
          </div>

          
          <div id="chart__<%= subject.subject_id %>__<%= format.id %>">
          </div>

 <script>
    let averageGradeNoTwo_<%= subject.subject_id %>__<%= format.id %> = <%- JSON.stringify(subject.tests.map((test) => { 

       return test.students.map((student) => {

         if(student.results[0]) {
          let percents = Math.round((student.results[0].points / student.results[0].max_points) * 100);
          let grade;

          if(percents > test.score_five) {
            grade = 5;
          } else if(percents > test.score_four) {
            grade = 4;
          } else if(percents > test.score_three) {
            grade = 3;
          } else {
            return;
          }
           return grade;

         } else {
           return;
         }

       })
      })
      .map((el) => {
        let grades =  el.filter((grade) => grade != null)
        let gradesSum = grades.reduce((a, b) => a + b, 0)
        
          return gradesSum / grades.length;
      })
      ) %>


      let gradeTwoSum_<%= subject.subject_id %>__<%= format.id %> = <%- JSON.stringify(subject.tests.map((test) => {

        return test.students.map((student) => {

          if(student.results[0]) {
          let percents = Math.round((student.results[0].points / student.results[0].max_points) * 100);
          let grade = 0;
            if(percents < test.score_three) {
              grade += 1;
            }
            return grade;
          }
          return;

        })

      })
      .map((el) => {
          let grades = el.filter((grade) => grade != null)
          let sumTwo = grades.reduce((a, b) => a + b, 0)
          return sumTwo;
      })
      ) %>

      let dates_<%= subject.subject_id %>__<%= format.id %> = <%- JSON.stringify(subject.tests.map((test) => {

        return test.test_date.toLocaleDateString('ru-RU');

      })) %>


      let studentsSum_<%= subject.subject_id %>__<%= format.id %> = <%- JSON.stringify(subject.tests.reduce((acc, test, i) => {

        acc.push(test.students.reduce((acc2, student) => {
          if(student.results[0]) {
          acc2 += 1;
          }
          return acc2; 
        }, 0))
        return acc

      }, [])) %>

      let fourGrades_<%= subject.subject_id %>__<%= format.id %> = <%- JSON.stringify(subject.tests.map((test) => {

        return 4;

      })) %>

    var options = {
  series: [
  {
    name: "Кривая успеваемости",
    data: averageGradeNoTwo_<%= subject.subject_id %>__<%= format.id %>,
    type: 'line'
  },
  {
    name: "Количество двоечников",
    data: gradeTwoSum_<%= subject.subject_id %>__<%= format.id %>,
    type: 'column',
    fill: {
      colors: ['#D8583D']
}
  },
  {
    name: "Прямая качества",
    data: fourGrades_<%= subject.subject_id %>__<%= format.id %>,
    type: 'line'
  },
],
  chart: {
  type: 'line',
  height: 350,
  toolbar: {
    show: false
  }
},
colors: ['#5674ED', '	#D8583D', '#006200'],
fill: {
      colors: ['#D8583D']
},
dataLabels: {
  enabled: true,
},
stroke: {
  curve: 'smooth',
},
title: {
  text: 'График успеваемости',
  align: 'left'
},
markers: {
  size: 3
},
xaxis: {
  categories: dates_<%= subject.subject_id %>__<%= format.id %>,
  title: {
    text: 'Время'
  },
},
yaxis: {
  title: {
    text: 'Средний балл'
  },
  min: 0,
  max: 5,
},
legend: {
  position: 'top',
  horizontalAlign: 'right',
  floating: true,
  offsetY: -25,
  offsetX: -5
}
};

var chart = new ApexCharts(document.querySelector("#chart__<%= subject.subject_id %>__<%= format.id %>"), options);
chart.render();


 </script>


          <% } %>
          <% }); %>

      </div>
    </div>
    <% }); %>


<script>
    const transposeTable = (tbody, newContainerType = "tbody") => {
    const rows = Array.from(tbody.querySelectorAll("tr"));
    const newTbody = document.createElement(newContainerType);
    
    for (let rowIdx = 0; rowIdx < rows.length; rowIdx++) {
      const row = rows[rowIdx];
      const cells = Array.from(row.querySelectorAll("td, th"));

      for (let cellIdx = 0; cellIdx < cells.length; cellIdx++ ) {
        const cell = cells[cellIdx];
        const newRow = newTbody.children[cellIdx] || document.createElement("tr")
        if (!newTbody.children[cellIdx]) {
          newTbody.appendChild(newRow);
        }
        newRow.appendChild(cell.cloneNode(true));
      }
    }
      
    tbody.parentElement.appendChild(newTbody);
    tbody.parentElement.removeChild(tbody);
    }
    Array.from(document.querySelectorAll('tbody__reverse'))
      .forEach((table) => transposeTable(table));
    
      Array.from(document.querySelectorAll('.student_name')).forEach((student) => {
    
        const students_col = student.parentElement;
        const index_in_col = Array.from(students_col.children).indexOf(student);
        const table_tbody = students_col.parentElement;

        const table_tbody_length = table_tbody.children.length;

        let counter = 0;
    
        Array.from(table_tbody.children).forEach((col, index) => {
          if(index == table_tbody.children.length) {
            return;
          }

          if(col.children[index_in_col].innerHTML.trim() == '-') {
            counter = counter + 1;
          }
        });
        
        if((table_tbody_length - 1) == counter) {
          Array.from(table_tbody.children).forEach((col) => {
            col.children[index_in_col].remove();
          });
        }
    
      });





function exportReportToExcel(e) {
  let table = e.previousElementSibling.firstElementChild;
  let subjectName = `Таблица с herokuapp`; // you can use document.getElementById('tableId') as well by providing id to the table tag
  TableToExcel.convert(table, { // html code may contain multiple tables so here we are refering to 1st table tag
    name: `${subjectName}.xlsx`, // fileName you could use any name
    sheet: {
      name: 'Sheet 1' // sheetName
    }
  });
}

    </script>




    <% subjects.forEach(function(subject) { %>

      <div class="row d-flex flex-column group__block my-3">
      <div class="accordion" id="accordion">
        <div class="accordion-item">
          <h2 class="accordion-header" id="headingSubject_<%= subject.id %>">
            <button class="accordion-button d-block text-center bg-primary" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSubject_<%= subject.id %>" aria-expanded="true" aria-controls="collapseSubject_<%= subject.id %>">
              <h5 class="text-light">Характеристики по предмету: <%= subject.name %></h5>
            </button>
          </h2>
          <div id="collapseSubject_<%= subject.id %>" class="accordion-collapse collapse" aria-labelledby="headingSubject_<%= subject.id %>" data-bs-parent="#accordion">
            <div class="accordion-body d-flex flex-column bg-warning">

                <div class="table-responsive-lg">
                  <table class="table table-striped table-hover table-bordered border-primary">
                    <tr>
                       <th>Дата проведения</th>
                       <th>Предмет</th>
                       <th>Посещаемость</th>
                       <th>Активность</th>
                       <th>Выполнение ДЗ</th>
                       <th>Подробнее</th>
                    </tr>
                    <% reviews.filter((review) => review.name == subject.name).sort(function(a, b) { return new Date(b.posting_date) - new Date(a.posting_date); }).forEach(function(review) { %>
                    <tr>
                        <th class="date"><%= review.posting_date.toLocaleDateString('ru-RU') %></th>
                        <th><%= review.name %></th>
                        <th class="attendance"><%= review.attendance %></th>
                        <th class="activity"><%= review.activity %></th>
                        <th class="homework"><%= review.homework %></th>
                        <th>
                          <a href=<%= `${globalLink}/reviews/${review.review_id}/` %> class="btn btn-warning my-2">
                          <strong>Перейти</strong>
                          </a>
                        </th>
                    </tr>
                    <% }); %>
                 </table>
                </div>
              </div>
          </div>
        </div>
      </div>
    </div>


    <% }); %>

</div>


<%- include ("../partials/footer.ejs") %>
