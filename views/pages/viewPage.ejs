<!DOCTYPE html>
<html>
<head>
  <%- include ("../partials/header.ejs") %>
</head>

<body>

<div class="container">

    <div class="row d-flex student__block my-4">
        <div class="col">
            <div class="student__info flex-column">
                <h4>
                    <%= student.name %>
                </h4>
                <h5>
                    Класс ученика:
                    <%= student.class_number %>
                </h5>
                <h5>
                    Предметы ученика:
                </h5>
                <div class="subjects_content my-2">
                  <% subjects.forEach(function(subject) { %>
                    <button class="btn btn-secondary m-1"><%= subject.name %></button>
                    <% }); %>
                </div>


            </div>
        </div>
    </div>

    <% if(student.trials.length > 0) { %>
    <div class="row d-flex flex-column group__block mb-1 mt-3">
        <h4 class="my-2 text-primary">Результаты по пробному тестированию ЕНТ</h4>
      <div class="table-responsive-lg">
        <table class="table table-striped table-hover table-bordered border-primary">
          <tr>
            <th>Дата</th>
            <th>Общий балл</th>
            <th>История Каз-на</th>
            <th>Грам-ть чтения</th>
            <th>Мат. грамотность</th>
            <th>Математика</th>
            <th>Физика&emsp;</th>
            <th>Геометрия</th>
            <th>Биология</th>
            <th>Химия&emsp;</th>
          </tr>
          <% student.trials.sort(function(a, b) { return new Date(a.trial_date) - new Date(b.trial_date); }).forEach(function(trial) { %>
          <tr>
            <th class="trials_date"><%= trial.trial_date.toLocaleDateString('ru-RU') %></th>
            <th>
              <%= trial.history_kaz_result + trial.reading_literacy_result + trial.math_literacy_result + trial.mathematics_result + trial.physics_result + trial.geography_result + trial.biology_result + trial.chemistry_result%> 

            </th>
            <th class="trials_history_kaz_result">
              <% if(trial.history_kaz_result) { %>
              <%= trial.history_kaz_result %> из 15
              <% } %>
            </th>
            <th class="trials_reading_literacy_result">
              <% if(trial.reading_literacy_result) { %>
                <%= trial.reading_literacy_result %> из 20
                <% } %>
            </th>
            <th class="trials_math_literacy_result">
              <% if(trial.math_literacy_result) { %>
              <%= trial.math_literacy_result %> из 15
              <% } %>
            </th>
            <th class="trials_mathematics_result">
              <% if(trial.mathematics_result) { %>
              <%= trial.mathematics_result %> из 45
              <% } %>
            </th>
            <th class="trials_physics_result">
              <% if(trial.physics_result) { %>
              <%= trial.physics_result %> из 45
              <% } %>
            </th>
            <th class="trials_geography_result">
              <% if(trial.geography_result) { %>
              <%= trial.geography_result %> из 45
              <% } %>
            </th>
            <th class="trials_biology_result">
              <% if(trial.biology_result) { %>
              <%= trial.biology_result %> из 45
              <% } %>
            </th>
            <th class="trials_chemistry+results">
              <% if(trial.chemistry_result) { %>
              <%= trial.chemistry_result %> из 45
              <% } %>
            </th>
          </tr>
          <% }); %>
        </table>
      </div>
      <div class="col py-2">
        <div id="ent_trials_chart">
        </div>
      </div>
    </div>


    <script>
      const trials_dates = Array.from(document.querySelectorAll('.trials_date'));
      const mathematics_results = Array.from(document.querySelectorAll('.mathematics_result'));
      const history_kaz_results = Array.from(document.querySelectorAll('.history_kaz_result'));
      const reading_literacy_results = Array.from(document.querySelectorAll('.reading_literacy_result'));
      const mathematics_results = Array.from(document.querySelectorAll('.math_literacy_result'));
      const physics_results = Array.from(document.querySelectorAll('.physics_result'));
      const geography_results = Array.from(document.querySelectorAll('.geography_result'));
      const biology_results = Array.from(document.querySelectorAll('.bioligy_result'));
      const chemistry_results = Array.from(document.querySelectorAll('.chemistry_result'))

      var options = {
          series: [
          {
            name: "High - 2013",
            data: [28, 29, 33, 36, 32, 32, 33]
          },
          {
            name: "Low - 2013",
            data: [12, 11, 14, 18, 17, 13, 13]
          }
        ],
          chart: {
          height: 350,
          type: 'line',
          dropShadow: {
            enabled: true,
            color: '#000',
            top: 18,
            left: 7,
            blur: 10,
            opacity: 0.2
          },
          toolbar: {
            show: false
          }
        },
        colors: ['#77B6EA', '#545454'],
        dataLabels: {
          enabled: true,
        },
        stroke: {
          curve: 'smooth'
        },
        title: {
          text: 'Average High & Low Temperature',
          align: 'left'
        },
        grid: {
          borderColor: '#e7e7e7',
          row: {
            colors: ['#f3f3f3', 'transparent'], // takes an array which will be repeated on columns
            opacity: 0.5
          },
        },
        markers: {
          size: 1
        },
        xaxis: {
          categories: trials_dates,
          title: {
            text: 'Month'
          }
        },
        yaxis: {
          title: {
            text: 'Temperature'
          },
          min: 5,
          max: 40
        },
        legend: {
          position: 'top',
          horizontalAlign: 'right',
          floating: true,
          offsetY: -25,
          offsetX: -5
        }
        };

        var chart = new ApexCharts(document.querySelector("#ent_trials_chart"), options);
        chart.render();




    </script>
    <% } %>


    <% subjects.forEach(function(subject) { %>

    <% if(student.results.filter((result) => result.subject_id == subject.subject_id).length !== 0) {  %>
      <div class="row d-flex flex-column group__block mb-1 mt-3">
        <h4 class="my-2 text-primary">Результаты тестов по предмету: <%= subject.name %></h4>
      <div class="table-responsive-lg">
        <table class="table table-striped table-hover table-bordered border-primary">
          <tr>
             <th>Дата проведения</th>
             <th>Предмет</th>
             <th>Формат тестирования</th>
             <th>Максимум баллов</th>
             <th>Набранные баллы</th>
             <th>% от максимума</th>
          </tr>
          <% student.results.filter((result) => result.subject_id == subject.subject_id).sort(function(a, b) { return new Date(a.date) - new Date(b.date); }).forEach(function(result) { %>
          <tr>
            <th class="date_<%= subject.id %>"><%= result.date.toLocaleDateString('ru-RU') %></th>
            <th><%= subject.name %></th>
            <th><%= result.format %></th>
            <th><%= result.max_points %></th>
            <th><%= result.points %></th>
            <th class="percent_<%= subject.id %>"><%= Math.round((result.points / result.max_points) * 100) %></th>
          </tr>
          <% }); %>
        </table>
      </div>
      <div class="col py-2">
        <div id="chart_<%= subject.id %>">
        </div>
      </div>
      </div>
  <script> 

    

var options = {
              series: [{
              name: '% от максимума',
              type: 'line',
              data: Array.from(document.querySelectorAll('.percent_<%= subject.id %>')).map((el) => el.innerHTML),
            }],
              chart: {
              height: 350,
              type: 'line',
            },
            stroke: {
              width: [4, 4]
            },
            markers: {
              size: 3
            },
            title: {
              text: 'График успеваемости группы'
            },
            dataLabels: {
              enabled: true,
              enabledOnSeries: [1]
            },
            labels: Array.from(document.querySelectorAll('.date_<%= subject.id %>')).map((el) => el.innerHTML),
            xaxis: {
              type: 'date'
            },
            yaxis: [{
              title: {
                text: '% от максимума',
              },
              max: 100,
              min: 0,
            }]
            };


            var chart_<%= subject.id %> = new ApexCharts(document.querySelector("#chart_<%= subject.id %>"), options).render();
    </script>

        <% } %>


        <% if(records.filter((record) => record.name == subject.name).length !== 0) { %>
        <div class="row d-flex flex-column group__block my-1">
        <div class="accordion" id="accordion">
          <div class="accordion-item">
            <h2 class="accordion-header" id="headingSubject_<%= subject.id %>">
              <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSubject_<%= subject.id %>" aria-expanded="true" aria-controls="collapseSubject_<%= subject.id %>">
                <h5 class="text-center text-primary">Ревью занятий по предмету: <%= subject.name %></h5>
              </button>
            </h2>
            <div id="collapseSubject_<%= subject.id %>" class="accordion-collapse collapse" aria-labelledby="headingSubject_<%= subject.id %>" data-bs-parent="#accordion">
              <div class="accordion-body d-flex flex-column bg-warning">
  
                  <div class="table-responsive-lg">
                    <table class="table table-striped table-hover table-bordered border-primary">
                      <tr>
                         <th>Дата проведения</th>
                         <th>Предмет</th>
                         <th>Посещаемость</th>
                         <th>Активность</th>
                         <th>Домашнее задание</th>
                      </tr>
                      <% records.filter((record) => record.name == subject.name).forEach(function(record) { %>
                      <tr>
                          <th class=""><%= record.posting_date.toLocaleDateString('ru-RU') %></th>
                          <th><%= record.name %></th>
                          <th><% if(record.attendance) { %>
                            <p class="attendance">Посетил</p>
                            <% } else { %>
                            <p class="attendance">Отсутствовал</p>
          
                          <% } %>
                            </th>
                            <th><% if(record.activity) { %>
                              <p class="activity">Активен</p>
                              <% } else { %>
                                <p class="activity">Не активен</p>
                            <% } %>
                              </th>
                              <th><% if(record.homework) { %>
                                <p class="homework">Выполнил</p>
                                <% } else { %>
                                  <p class="homework">Не выполнил</p>
                              <% } %>
                                </th>
                      </tr>
                      <% }); %>
                   </table>
                  </div>
                </div>
            </div>
          </div>
        </div>
      </div>
        <script>

          const attendance = Array.from(document.querySelectorAll('.attendance'))
          .map((el) => el.innerHTML)
          const attended = Array.from(document.querySelectorAll('.attendance'))
          .map((el) => el.innerHTML).filter((el) => el == 'Посетил');
        
          const activity = Array.from(document.querySelectorAll('.activity'))
          .map((el) => el.innerHTML)
          const active = Array.from(document.querySelectorAll('.activity'))
          .map((el) => el.innerHTML).filter((el) => el == 'Активен');
        
          const homework = Array.from(document.querySelectorAll('.homework'))
          .map((el) => el.innerHTML)
          const doneHomework = Array.from(document.querySelectorAll('.homework'))
          .map((el) => el.innerHTML).filter((el) => el == 'Выполнил');
        
        
        console.log(Math.round(((attended.length / attendance.length)
                               + (active.length / activity.length)
                              + (doneHomework.length / homework.length)) / 3 ))
        
        
              var options = {
                  series: [Math.round(attended.length / attendance.length * 100),
                   Math.round(active.length / activity.length * 100), 
                   Math.round(doneHomework.length / homework.length * 100)],
                  chart: {
                  height: 350,
                  type: 'radialBar',
                },
                plotOptions: {
                  radialBar: {
                    dataLabels: {
                      name: {
                        fontSize: '18px',
                        color: '#3377FF',
                      },
                    },
                    
                  }
                },
                fill: {
                  opacity: 1.5,
                  colors: ['#3377FF', '#FF3396', '#3BDD51' ],
                  type: 'gradient',
                },
                labels: ['Посещаемость', 'Активность', 'Выполнение ДЗ'],
                };
        
                var chart = new ApexCharts(document.querySelector("#chart_records"), options);
                chart.render();
        
        
        </script>
<% } %>

<% }); %>


</div>



