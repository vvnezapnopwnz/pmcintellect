<!DOCTYPE html>
<html>
<head>
  <%- include ("../partials/header.ejs") %>
</head>

<body>

<%- include ("../partials/nav.ejs") %>

<div class="container">

    <div class="row d-flex student__block my-4">
        <div class="col">
            <div class="student__info flex-column">
                <h4>
                    <%= student.name %>
                </h4>
                <h5>
                    Класс ученика:
                    <%= student.class_number %>
                </h5>
                <h5>
                    Предметы ученика:
                </h5>
                <div class="subjects_content my-2">
                  <% subjects.forEach(function(subject) { %>
                    <button class="btn btn-secondary m-1"><%= subject.name %></button>
                    <% }); %>
                    <a href=<%= `${globalLink}/students/${student.student_id}/addSubject` %> class="btn btn-success m-1">
                    Добавить ученику предмет <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-square" viewBox="0 0 16 16">
                      <path d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"/>
                      <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                    </svg>
                    </a>
                    <a href=<%= `${globalLink}/students/${student.student_id}/removeSubject` %> class="btn btn-danger m-1">
                      Удалить предмет у ученика
                    </a>
                </div>


            </div>
        </div>
    </div>



    <% subjects.forEach(function(subject) { %>

      <% if(student.results.filter((result) => result.subject_id == subject.subject_id).length !== 0) {  %>
      <div class="row d-flex flex-column group__block my-3">
        <h4 class="text-center my-2">Результаты по предмету: <%= subject.name %></h4>
      <div class="table-responsive-lg">
        <table class="table table-striped table-hover table-bordered border-primary">
          <tr>
             <th>Дата проведения</th>
             <th>Предмет</th>
             <th>Формат тестирования</th>
             <th>Максимум баллов</th>
             <th>Набранные баллы</th>
             <th>% от максимума</th>
          </tr>
          <% student.results.filter((result) => result.subject_id == subject.subject_id).sort(function(a, b) { return new Date(a.date) - new Date(b.date); }).forEach(function(result) { %>
          <tr>
            <th class="date_<%= subject.id %>"><%= result.date.toLocaleDateString('ru-RU') %></th>
            <th><%= result.subject_name %></th>
            <th><%= result.format %></th>
            <th><%= result.max_points %></th>
            <th><%= result.points %></th>
            <th class="percent_<%= subject.id %>"><%= Math.round((result.points / result.max_points) * 100) %></th>
          </tr>
        <% }); %>
      </table>
    </div>


    <div class="col py-2">
      <div id="chart_<%= subject.id %>">
      </div>

    </div>
  </div> 

  <script> 
var options = {
              series: [{
              name: '% от максимума',
              type: 'line',
              data: Array.from(document.querySelectorAll('.percent_<%= subject.id %>')).map((el) => el.innerHTML),
            }],
              chart: {
              height: 350,
              type: 'line',
            },
            stroke: {
              width: [4, 4]
            },
            markers: {
              size: 3
            },
            title: {
              text: 'График успеваемости группы'
            },
            dataLabels: {
              enabled: true,
              enabledOnSeries: [1]
            },
            labels: Array.from(document.querySelectorAll('.date_<%= subject.id %>')).map((el) => el.innerHTML),
            xaxis: {
              type: 'date'
            },
            yaxis: [{
              title: {
                text: '% от максимума',
              },
              max: 100,
              min: 0,
            }]
            };
    
            var chart_<%= subject.id %> = new ApexCharts(document.querySelector("#chart_<%= subject.id %>"), options).render();
    </script>

        <% } %>

    <% }); %>

    <div class="row d-flex flex-column group__block my-3">
      <div class="col">
        <h4 class="text-center my-2">Ревью занятий</h4>

        <div class="table-responsive-lg">
          <table class="table table-striped table-hover table-bordered border-primary">
            <tr>
               <th>Дата проведения</th>
               <th>Предмет</th>
               <th>Посещаемость</th>
               <th>Активность</th>
               <th>Домашнее задание</th>
            </tr>
            <% records.forEach(function(record) { %>
            <tr>
                <th class=""><%= record.posting_date.toLocaleDateString('ru-RU') %></th>
                <th><%= record.name %></th>
                <th><% if(record.attendance) { %>
                  <p class="attendance">Посетил</p>
                  <% } else { %>
                  <p class="attendance">Отсутствовал</p>

                <% } %>
                  </th>
                  <th><% if(record.activity) { %>
                    <p class="activity">Активен</p>
                    <% } else { %>
                      <p class="activity">Не активен</p>
                  <% } %>
                    </th>
                    <th><% if(record.homework) { %>
                      <p class="homework">Выполнил</p>
                      <% } else { %>
                        <p class="homework">Не выполнил</p>
                    <% } %>
                      </th>
            </tr>
            <% }); %>
         </table>
        </div>

      </div>

      <div class="col">
        <div class="col py-2">
          <div id="chart_records">
          </div>
    
        </div>


      </div>

    </div>

</div>


<script>

  const attendance = Array.from(document.querySelectorAll('.attendance'))
  .map((el) => el.innerHTML)
  const attended = Array.from(document.querySelectorAll('.attendance'))
  .map((el) => el.innerHTML).filter((el) => el == 'Посетил');

  const activity = Array.from(document.querySelectorAll('.activity'))
  .map((el) => el.innerHTML)
  const active = Array.from(document.querySelectorAll('.activity'))
  .map((el) => el.innerHTML).filter((el) => el == 'Активен');

  const homework = Array.from(document.querySelectorAll('.homework'))
  .map((el) => el.innerHTML)
  const doneHomework = Array.from(document.querySelectorAll('.homework'))
  .map((el) => el.innerHTML).filter((el) => el == 'Выполнил');


console.log(Math.round(((attended.length / attendance.length)
                       + (active.length / activity.length)
                      + (doneHomework.length / homework.length)) / 3 ))


      var options = {
          series: [Math.round(attended.length / attendance.length * 100),
           Math.round(active.length / activity.length * 100), 
           Math.round(doneHomework.length / homework.length * 100)],
          chart: {
          height: 350,
          type: 'radialBar',
        },
        plotOptions: {
          radialBar: {
            dataLabels: {
              name: {
                fontSize: '18px',
                color: '#3377FF',
              },
            },
            
          }
        },
        fill: {
          opacity: 1.5,
          colors: ['#3377FF', '#FF3396', '#3BDD51' ],
          type: 'gradient',
        },
        labels: ['Посещаемость', 'Активность', 'Выполнение ДЗ'],
        };

        var chart = new ApexCharts(document.querySelector("#chart_records"), options);
        chart.render();


</script>


<%- include ("../partials/footer.ejs") %>